# SECTION 03. 서블릿, JSP, MVC 패턴

## 회원 관리 웹 애플리케이션 요구사항

- 회원 정보: 이름, 나이
- 기능 요구사항: 회원 저장, 회원 목록 조회

- 회원 도메인 모델 생성: Member
    - id는 Member 를 회원 저장소에 저장하면 회원 저장소가 할당한다.

- 회원 저장소: MemberRepository
    - 싱글톤 패턴 적용 -> 순수 서블릿 만으로 구현할 예정이기 때문
    - 싱글톤 패턴은 객체를 단 하나만 생생해서 공유해야 하므로 생성자를 private 접근자로 막아둔다.

- 회원 저장소 테스트 코드
    - . 각 테스트가 끝날 때, 다음 테스트에 영향을 주지 않도록 각 테스트의 저장소를 clearStore() 를 호출해서 초기화

## 서블릿으로 회원 관리 웹 애플리케이션 만들기

- MemberFormServlet - 회원 등록 폼
    - HTML Form 데이터를 POST로 전송해도, 전달 받는 서블릿을 아직 만들지 않았다.    
    - -> 오류가 발생하는 것이 정상

- MemberSaveServlet - 회원 저장
    - 동작 순서
    1. 파라미터를 조회해서 Member 객체를 만든다.
    2. Member 객체를 MemberRepository를 통해서 저장한다.
    3. Member 객체를 사용해서 결과 화면용 HTML을 동적으로 만들어서 응답한다.

- MemberListServlet - 회원 목록
    - 동작 순서
    1. memberRepository.findAll() 을 통해 모든 회원을 조회한다.
    2. 회원 목록 HTML을 for 루프를 통해서 회원 수 만큼 동적으로 생성하고 응답한다.

* 템플릿 엔진으로

- 자바 코드로 HTML을 만들어 내는 것 보다 차라리 HTML 문서에 동적으로 변경해야 하는 부분만 자바 코드를 넣을 수 있다면 더 편리할 것
    - -> 템플릿 엔진이 나온 이유
    - 템플릿 엔진을 사용하면 HTML 문서에서 필요한 곳만 코드를 적용해서 동적으로 변경할 수 있다.
    - JSP, Thymeleaf, Freemarker, Velocity등

- Welcome 페이지 변경

## JSP로 회원 관리 웹 애플리케이션 만들기

- build.gradle에 JSP 라이브러리 추가

- 기존의 회원 등록 폼, 회원 저장, 회원 목록 모두 jsp로 변경
- JSP는 서버 내부에서 서블릿으로 변환되는데, 우리가 만들었던 MemberFormServlet과 거의 비슷한 모습으로 변환

- JSP는 자바 코드를 그대로 다 사용할 수 있다.
    - <% ~~ %>  -> 이 부분에는 자바 코드를 입력할 수 있다.
    - <%= ~~ %> -> 이 부분에는 자바 코드를 출력할 수 있다.

* MVC 패턴의 등장

- 서블릿의 한계: 뷰(View)화면을 위한 HTML을 만드는 작업이 자바 코드에 섞여서 지저분하고 복잡

- JSP의 한계: JAVA 코드, 데이터를 조회하는 리포지토리 등등 다양한 코드가 모두 JSP에 노출되어 있다. JSP가 너무 많은 역할을 함

- 비즈니스 로직은 서블릿 처럼 다른곳에서 처리하고, JSP는 목적에 맞게 HTML로 화면(View)을 그리는 일에 집중하도록 하자 -> MVC 패턴

## MVC 패턴 - 개요

- 너무 많은 역할, 변경의 라이프 사이클 -> 유지보수에 좋지 않음

* Model View Controller
    - MVC 패턴은 지금까지 학습한 것 처럼 하나의 서블릿이나, JSP로 처리하던 것을 컨트롤러(Controller)와 뷰(View)라는 영역으로 서로 역할을 나눈 것
    - 웹 애플리케이션은 보통 이 MVC 패턴을 사용

    * 컨트롤러
    - HTTP 요청을 받아서 파라미터를 검증하고, 비즈니스 로직을 실행한다. 그리고 뷰에 전달할 결과 데이터를 조회해서 모델에 담는다.

    * 모델
    - 뷰에 출력할 데이터를 담아둔다. 뷰가 필요한 데이터를 모두 모델에 담아서 전달해주는 덕분에 뷰는 비즈니스 로직이나 데이터 접근을 몰라도 되고, 화면을 렌더링 하는 일에 집중할 수 있다.

    * 뷰
    - 모델에 담겨있는 데이터를 사용해서 화면을 그리는 일에 집중한다. 여기서는 HTML을 생성하는 부분을 말한다.

    * 참고
    - 컨트롤러에 비즈니스 로직을 둘 수도 있지만, 이렇게 되면 컨트롤러가 너무 많은 역할을 담당한다. 
    - 그래서 일반적으로 비즈니스 로직은 서비스(Service)라는 계층을 별도로 만들어서 처리한다. 그리고 컨트롤러는 비즈니스 로직이 있는 서비스를 호출하는 담당한다. 
    - 참고로 비즈니스 로직을 변경하면 비즈니스 로직을 호출하는 컨트롤러의 코드도 변경될 수 있다

## MVC 패턴 - 적용

- 서블릿을 컨트롤러로 사용하고, JSP를 뷰로 사용해서 MVC 패턴을 적용해보자.
- Model은 HttpServletRequest 객체를 사용한다. request는 내부에 데이터 저장소를 가지고 있는데, request.setAttribute() , request.getAttribute() 를 사용하면 데이터를 보관하고, 조회할 수 있다.

* 적용

- 회원 등록 폼 - 컨트롤러
    -  dispatcher.forward() : 다른 서블릿이나 JSP로 이동할 수 있는 기능이다. 서버 내부에서 다시 호출이 발생한다.

    - /WEB-INF
        - -> 이 경로안에 JSP가 있으면 외부에서 직접 JSP를 호출할 수 없다. 우리가 기대하는 것은 항상 컨트롤러를 통해서 JSP를 호출하는 것이다.

    - redirect vs forward
        - 리다이렉트는 실제 클라이언트(웹 브라우저)에 응답이 나갔다가, 클라이언트가 redirect 경로로 다시 요청한다. 따라서 클라이언트가 인지할 수 있고, URL 경로도 실제로 변경된다. 
        - 반면에 포워드는 서버 내부에서 일어나는 호출이기 때문에 클라이언트가 전혀 인지하지 못한다.

- 회원 등록 폼 - 뷰
    -  form의 action을 보면 절대 경로(슬래시로 시작)이 아니라 상대경로(슬래시로 시작X)하는 것을 확인할 수 있다. 이렇게 상대경로를 사용하면 폼 전송시 현재 URL이 속한 계층 경로 + save가 호출된다.

- 회원 저장 - 컨트롤러
    - HttpServletRequest를 Model로 사용한다.
    - request가 제공하는 setAttribute() 를 사용하면 request 객체에 데이터를 보관해서 뷰에 전달할 수 있다.
    - 뷰는 request.getAttribute() 를 사용해서 데이터를 꺼내면 된다.

- 회원 저장 - 뷰
    -  <%= request.getAttribute("member")%> 로 모델에 저장한 member 객체를 꺼낼 수 있지만, 너무 복잡해진다.
    - JSP는 ${} 문법을 제공하는데, 이 문법을 사용하면 request의 attribute에 담긴 데이터를 편리하게 조회할 수 있다.

- 회원 목록 조회 - 컨트롤러
    - request 객체를 사용해서 List<Member> members 를 모델에 보관했다.

- 회원 목록 조회 - 뷰
    - 모델에 담아둔 members를 JSP가 제공하는 taglib기능을 사용해서 반복하면서 출력했다. members 리스트에서 member 를 순서대로 꺼내서 item 변수에 담고, 출력하는 과정을 반복한다.
    - <c:forEach> 이 기능을 사용하려면 다음과 같이 선언해야 한다.
        - <%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>

## MVC 패턴 - 한계

- MVC 패턴을 적용한 덕분에 컨트롤러의 역할과 뷰를 렌더링 하는 역할을 명확하게 구분할 수 있다.
- 그런데 컨트롤러는 딱 봐도 중복이 많고, 필요하지 않는 코드들도 많이 보인다.

* MVC 컨트롤러의 단점

    * 포워드 중복
        - View로 이동하는 코드가 항상 중복 호출되어야 한다. 물론 이 부분을 메서드로 공통화해도 되지만, 해당 메서드도 항상 직접 호출해야 한다.

    * ViewPath에 중복
        - prefix: /WEB-INF/views/
        - suffix: .jsp
    - 만약 jsp가 아닌 thymeleaf 같은 다른 뷰로 변경한다면 전체 코드를 다 변경해야 한다.

    * 사용하지 않는 코드
        - HttpServletRequest request, HttpServletResponse response 사용할 때도 있고, 아닐 때도 있음

    * 정리
    - 공통 처리가 어렵다는 문제가 있다.
    - -> 컨트롤러 호출 전에 먼저 공통 기능을 처리해야 한다. 소위 수문장 역할을 하는 기능이 필요하다. 프론트 컨트롤러(Front Controller) 패턴을 도입하면 이런 문제를 깔끔하게 해결할 수 있다.(입구를 하나로!)


